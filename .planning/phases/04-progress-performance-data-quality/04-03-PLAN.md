---
phase: 04-progress-performance-data-quality
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/suburb_metrics.py
  - src/research/suburb_research.py
  - src/research/ranking.py
  - src/reporting/excel_exporter.py
  - src/ui/web/templates/suburb_report.html
  - src/ui/web/templates/index.html
autonomous: true

must_haves:
  truths:
    - "SuburbMetrics includes data_quality field that persists through research pipeline to reports"
    - "Suburbs with fallback data rank lower than suburbs with equal growth scores but high-quality data"
    - "Suburb HTML reports display visible warnings when data quality is low or fallback"
    - "Excel Demographics sheet has individual columns for household types and income bands instead of semicolon strings"
    - "Excel Infrastructure sheet has expanded columns for transport types, schools, crime, shopping"
  artifacts:
    - path: "src/models/suburb_metrics.py"
      provides: "data_quality and data_quality_details fields on SuburbMetrics"
      contains: "data_quality"
    - path: "src/research/ranking.py"
      provides: "Quality-adjusted ranking with configurable weights"
      contains: "quality_adjusted"
    - path: "src/reporting/excel_exporter.py"
      provides: "Expanded demographics and infrastructure columns"
      contains: "families_with_children"
    - path: "src/ui/web/templates/suburb_report.html"
      provides: "Data quality warning banner"
      contains: "data-quality-warning"
  key_links:
    - from: "src/research/suburb_research.py"
      to: "src/models/suburb_metrics.py"
      via: "Research response parsing populates data_quality field"
      pattern: "data_quality"
    - from: "src/research/ranking.py"
      to: "src/config/settings.py"
      via: "Ranking reads RANKING_QUALITY_WEIGHTS from settings"
      pattern: "RANKING_QUALITY_WEIGHTS"
    - from: "src/reporting/excel_exporter.py"
      to: "src/models/suburb_metrics.py"
      via: "Excel export reads demographics.household_types dict keys into individual columns"
      pattern: "household_types"
---

<objective>
Add data quality tracking throughout the research pipeline, implement quality-adjusted ranking, display warnings in HTML reports, and expand Excel exports with detailed demographic and infrastructure columns.

Purpose: Users need to know when suburb data comes from unreliable sources, rankings should penalize low-confidence data, and Excel exports should provide analysis-ready breakdowns rather than collapsed string fields.

Output: Data quality field in SuburbMetrics, quality-adjusted ranking algorithm, HTML warning banners, expanded Excel sheets.
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-progress-performance-data-quality/04-RESEARCH.md
@src/models/suburb_metrics.py
@src/research/suburb_research.py
@src/research/ranking.py
@src/reporting/excel_exporter.py
@src/ui/web/templates/suburb_report.html
@src/ui/web/templates/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Data quality model fields, research prompt update, and quality-adjusted ranking</name>
  <files>
    src/models/suburb_metrics.py
    src/research/suburb_research.py
    src/research/ranking.py
  </files>
  <action>
1. In `src/models/suburb_metrics.py`, add two new fields to the `SuburbMetrics` class:
   ```python
   data_quality: str = Field(
       default="medium",
       description="Overall data quality: high, medium, low, or fallback"
   )
   data_quality_details: dict = Field(
       default_factory=dict,
       description="Per-field quality indicators, e.g. {'median_price': 'high', 'demographics': 'fallback'}"
   )
   ```
   Place these after the `growth_projections` field. Add a field_validator for `data_quality` that normalizes to one of ["high", "medium", "low", "fallback"] and defaults to "medium" for invalid values.

2. In `src/research/suburb_research.py`:
   - Find the research prompt template (the large f-string passed to Perplexity/Anthropic)
   - Add `data_quality` and `data_quality_details` to the JSON schema in the prompt:
     ```
     "data_quality": "high|medium|low|fallback",
     "data_quality_details": {
       "median_price": "high|medium|low|fallback",
       "demographics": "high|medium|low|fallback",
       "infrastructure": "high|medium|low|fallback",
       "crime_stats": "high|medium|low|fallback"
     }
     ```
   - Add instruction text to the prompt explaining quality levels:
     ```
     Set data_quality based on source reliability:
     - "high": Official sources (ABS, CoreLogic, Domain, REA Group, government)
     - "medium": Mixed sources, some third-party data
     - "low": Mostly estimates or outdated data
     - "fallback": Calculated/interpolated when direct data unavailable
     ```
   - In `_parse_metrics_from_json()` (or equivalent parsing function), extract `data_quality` and `data_quality_details` from the JSON and pass to SuburbMetrics constructor
   - In `_create_fallback_metrics()`, set `data_quality="fallback"` and `data_quality_details={"all_fields": "fallback"}`

3. In `src/research/ranking.py`:
   - Import settings: `from src.config import settings`
   - Add quality-adjusted scoring function:
     ```python
     def calculate_quality_adjusted_score(metrics) -> float:
         """Apply quality penalty to composite score."""
         base_score = metrics.growth_projections.composite_score
         weight = settings.RANKING_QUALITY_WEIGHTS.get(metrics.data_quality, 0.95)
         return base_score * weight
     ```
   - Update `rank_suburbs()` to support a new `ranking_method="quality_adjusted"` option:
     - When `ranking_method == "quality_adjusted"`: sort by `calculate_quality_adjusted_score(r.metrics)`
     - Make `"quality_adjusted"` the new default (or use `settings.DEFAULT_RANKING_METHOD`)
     - Keep existing ranking methods (growth_score, composite_score, 5yr_growth) as alternatives
   - NOTE: If settings.RANKING_QUALITY_WEIGHTS or settings.DEFAULT_RANKING_METHOD don't exist yet (plan 04-02 not run), use inline defaults:
     ```python
     _DEFAULT_QUALITY_WEIGHTS = {"high": 1.0, "medium": 0.95, "low": 0.85, "fallback": 0.70}
     weights = getattr(settings, 'RANKING_QUALITY_WEIGHTS', _DEFAULT_QUALITY_WEIGHTS)
     ```
  </action>
  <verify>
    - `python -c "from src.models.suburb_metrics import SuburbMetrics; s = SuburbMetrics.__fields__; assert 'data_quality' in s; print('field exists')"` (or Pydantic v2 equivalent: `SuburbMetrics.model_fields`)
    - `grep -n "data_quality" src/research/suburb_research.py` shows quality in both prompt and parsing
    - `grep -n "quality_adjusted" src/research/ranking.py` shows the new ranking method
    - `python -c "from src.research.ranking import calculate_quality_adjusted_score; print('import OK')"` succeeds
  </verify>
  <done>SuburbMetrics has data_quality and data_quality_details fields. Research prompts request quality assessment. Fallback metrics are tagged as fallback. Ranking supports quality-adjusted scoring that penalizes low-quality data.</done>
</task>

<task type="auto">
  <name>Task 2: HTML quality warnings and expanded Excel demographic/infrastructure columns</name>
  <files>
    src/ui/web/templates/suburb_report.html
    src/ui/web/templates/index.html
    src/reporting/excel_exporter.py
  </files>
  <action>
1. In `src/ui/web/templates/suburb_report.html`, add a data quality warning banner near the top of the report content (after the title/header section, before the main metrics):
   ```html
   {% if suburb.metrics.data_quality in ['low', 'fallback'] %}
   <div class="data-quality-warning" style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 6px; margin: 20px 0;">
       <h3 style="color: #856404; margin-top: 0;">Data Quality Notice</h3>
       <p>
           This report contains <strong>{{ suburb.metrics.data_quality }}</strong> quality data.
           {% if suburb.metrics.data_quality == 'fallback' %}
           Some metrics are calculated estimates due to limited official data availability.
           {% else %}
           Some metrics are based on estimates or older data sources.
           {% endif %}
       </p>
       {% if suburb.metrics.data_quality_details %}
       <details style="margin-top: 10px;">
           <summary style="cursor: pointer; font-weight: 600;">View field-level quality details</summary>
           <ul style="margin-top: 10px;">
               {% for field, quality in suburb.metrics.data_quality_details.items() %}
               {% if quality in ['low', 'fallback'] %}
               <li><strong>{{ field }}</strong>: {{ quality }}</li>
               {% endif %}
               {% endfor %}
           </ul>
       </details>
       {% endif %}
   </div>
   {% endif %}
   ```
   Adapt the Jinja2 variable names to match the actual template context (e.g., might be `report.metrics` instead of `suburb.metrics` -- read the file first to confirm).

2. In `src/ui/web/templates/index.html` (the overview/ranking page), add a quality indicator next to each suburb name in the ranking table:
   - After the suburb name cell content, add:
     ```html
     {% if report.metrics.data_quality == 'fallback' %}
     <span title="Fallback data quality" style="color: #dc3545; font-size: 0.8em; margin-left: 5px;">[fallback]</span>
     {% elif report.metrics.data_quality == 'low' %}
     <span title="Low data quality" style="color: #ffc107; font-size: 0.8em; margin-left: 5px;">[low quality]</span>
     {% endif %}
     ```
   - Add a "Data Quality" column to the ranking table header and cells:
     ```html
     <td>{{ report.metrics.data_quality | upper }}</td>
     ```
   Again, adapt variable names to match the actual template context.

3. In `src/reporting/excel_exporter.py`:

   **Add Data Quality column to Overview sheet:**
   - Find the Overview sheet header row and add "Data Quality" as a new column
   - For each suburb row, write `report.metrics.data_quality.upper()`

   **Expand Demographics sheet:**
   - Replace the current collapsed format (semicolon-joined household_types string) with individual columns:
     - Headers: Suburb, State, Median Age, Population Trend, Families with Children %, Couples %, Single Person %, Group Households %, Other Households %, Low Income %, Medium Income %, High Income %
     - For each suburb, extract values from `demographics.household_types` dict using the following expected keys:
       - "families_with_children" (or "families")
       - "couples" (or "couple_only")
       - "single_person" (or "single")
       - "group_households" (or "group")
       - "other" (or "other_households")
       - Use `.get(key, 0)` with default 0 for missing keys
     - Extract from `demographics.income_distribution` dict using expected keys:
       - "low_income" (or "low")
       - "medium_income" (or "medium")
       - "high_income" (or "high")
       - Use `.get(key, 0)` with default 0 for missing keys
   - Use `_safe_str()` for non-numeric fields, raw floats/ints for numeric fields

   **Expand Infrastructure sheet:**
   - Replace collapsed format with individual columns:
     - Headers: Suburb, State, Current Transport, Future Transport, Current Infrastructure, Planned Infrastructure, Major Events Impact, Schools Summary, Crime Stats Summary, Shopping Access
     - For list fields (current_transport, future_transport, etc.), join with newline character "\n" instead of semicolons for better readability in Excel
     - For dict fields (crime_stats), use `_safe_str()` but format as "key: value" pairs
   - If the infrastructure field has sub-lists, render each as a separate line within the cell
  </action>
  <verify>
    - `grep -n "data-quality-warning" src/ui/web/templates/suburb_report.html` finds the warning banner
    - `grep -n "data_quality" src/ui/web/templates/index.html` finds quality indicator in ranking table
    - `grep -n "families_with_children\|couples\|single_person\|low_income\|medium_income\|high_income" src/reporting/excel_exporter.py` shows expanded demographic columns with expected key names
    - `grep -n "Future Transport\|Planned Infrastructure\|Major Events" src/reporting/excel_exporter.py` shows expanded infrastructure columns
    - `grep -n "Data Quality" src/reporting/excel_exporter.py` shows quality column in Overview sheet
    - `python -c "from src.reporting.excel_exporter import generate_excel; print('import OK')"` succeeds
  </verify>
  <done>Suburb reports show yellow warning banner for low/fallback quality data. Overview ranking table shows quality column and inline indicators. Excel Demographics sheet has individual columns for household type percentages (families_with_children, couples, single_person, group_households, other) and income bands (low_income, medium_income, high_income) with explicit key names. Excel Infrastructure sheet has individual columns for transport, schools, crime, shopping. Excel Overview includes Data Quality column.</done>
</task>

</tasks>

<verification>
1. Model: SuburbMetrics with data_quality="fallback" can be instantiated without error
2. Ranking: A suburb with composite_score=80 and data_quality="high" ranks above one with composite_score=85 and data_quality="fallback" (80*1.0=80 > 85*0.70=59.5)
3. HTML: suburb_report.html has data-quality-warning div, index.html has quality column
4. Excel: Demographics and Infrastructure sheets have expanded columns, not collapsed strings
5. No import errors: all modified modules import successfully
</verification>

<success_criteria>
- SuburbMetrics carries data_quality through the full pipeline (research -> ranking -> reporting)
- Quality-adjusted ranking penalizes fallback data by 30%
- HTML reports show visible warnings for low/fallback quality
- Excel exports have individual columns for demographics and infrastructure
- Backward compatible: existing cached data loads with data_quality defaulting to "medium"
</success_criteria>

<output>
After completion, create `.planning/phases/04-progress-performance-data-quality/04-03-SUMMARY.md`
</output>
