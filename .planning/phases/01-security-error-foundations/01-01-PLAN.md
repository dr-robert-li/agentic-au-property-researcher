---
phase: 01-security-error-foundations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/security/__init__.py
  - src/security/sanitization.py
  - src/security/validators.py
  - src/config/settings.py
  - src/models/inputs.py
  - src/app.py
  - src/ui/web/server.py
autonomous: true

must_haves:
  truths:
    - "All .env values are fully redacted ([REDACTED]) from log output, even when third-party libraries log at DEBUG level"
    - "A region name not in the REGIONS whitelist is rejected with a clear error message before any API call"
    - "A run_id containing ../ or special characters is rejected at input boundary"
    - "A cache path pointing outside the cache directory is rejected"
    - "A missing or malformatted API key produces a clear startup error with actionable instructions"
    - "HTTP error responses from FastAPI never contain secret values"
  artifacts:
    - path: "src/security/__init__.py"
      provides: "Security module package"
    - path: "src/security/sanitization.py"
      provides: "SensitiveDataFilter logging filter and sanitize_text utility"
      contains: "class SensitiveDataFilter"
    - path: "src/security/validators.py"
      provides: "validate_run_id, validate_cache_path, validate_regions functions"
      contains: "def validate_run_id"
    - path: "src/config/settings.py"
      provides: "Startup validation with API key format checks"
      contains: "validate_api_key_format"
  key_links:
    - from: "src/security/sanitization.py"
      to: "root logger"
      via: "logging.getLogger().addFilter()"
      pattern: "addFilter.*SensitiveDataFilter"
    - from: "src/security/validators.py"
      to: "src/models/inputs.py"
      via: "field_validator calling validate functions"
      pattern: "validate_run_id|validate_regions"
    - from: "src/security/sanitization.py"
      to: "src/ui/web/server.py"
      via: "FastAPI exception handler calling sanitize_text"
      pattern: "sanitize_text"
---

<objective>
Harden the application against credential leaks and malicious input by implementing global log sanitization, input validation at model boundaries, and startup configuration checks.

Purpose: Close SEC-01 through SEC-05 security requirements -- API keys must never appear in any output path, all user inputs must be validated against whitelists/safe patterns before reaching API calls or filesystem operations, and startup must fail fast with clear instructions when configuration is invalid.

Output: New `src/security/` module with sanitization and validation utilities; updated settings.py with startup validation; updated UserInput model with strict validators; FastAPI global exception handler that sanitizes error responses.
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-error-foundations/01-RESEARCH.md
@src/config/settings.py
@src/config/regions_data.py
@src/models/inputs.py
@src/ui/web/server.py
@src/app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security module with sanitization filter and input validators</name>
  <files>
    src/security/__init__.py
    src/security/sanitization.py
    src/security/validators.py
  </files>
  <action>
Create `src/security/` package with three files:

**`src/security/__init__.py`:**
- Export key symbols: `SensitiveDataFilter`, `sanitize_text`, `install_log_sanitization`, `validate_run_id`, `validate_cache_path`, `validate_regions`

**`src/security/sanitization.py`:**
- Create `SensitiveDataFilter(logging.Filter)` class that:
  - On initialization, loads ALL values from `.env` file (using dotenv_values()) and builds regex patterns for each non-empty value
  - Also includes hardcoded patterns for common API key formats: `pplx-[a-f0-9]{20,}`, `sk-ant-[a-zA-Z0-9-_]{20,}`, `sk-[a-zA-Z0-9-_]{20,}`
  - Uses FULL redaction: replace with `[REDACTED]` (not partial masking -- per user locked decision and security best practices)
  - Overrides `filter(self, record)` to sanitize `record.msg` (if str), `record.args` (if tuple of strs), and `record.exc_text` (if set) against all patterns
  - Always returns True (allow record through)
- Create `sanitize_text(text: str) -> str` standalone function that applies the same redaction patterns to any arbitrary string (for use in HTTP error responses, print statements, etc.)
- Create `install_log_sanitization()` function that:
  - Instantiates `SensitiveDataFilter`
  - Attaches it to `logging.getLogger()` (root logger -- catches all loggers including third-party)
  - Sets third-party loggers (`httpx`, `httpcore`, `perplexity`, `anthropic`, `urllib3`) to WARNING level to reduce noise

**`src/security/validators.py`:**
- `validate_run_id(run_id: str) -> str`: Validates run_id matches `^[A-Za-z0-9_-]+$`, length 1-100 chars. Raises ValueError with clear message if invalid.
- `validate_cache_path(user_path: str, base_dir: Path) -> Path`: Uses `Path.resolve()` + `is_relative_to()` to verify path is within base_dir. Raises ValueError if path traversal detected. Returns resolved Path.
- `validate_regions(regions: list[str]) -> list[str]`: Imports REGIONS from `config.regions_data`. Each region must exist as a key in REGIONS dict. Uses case-insensitive matching with title-case normalization (e.g., "queensland" -> "Queensland"). Raises ValueError listing invalid regions and showing valid options.

No new dependencies needed -- all stdlib + existing dotenv.
  </action>
  <verify>
Run: `cd /Users/robertli/Desktop/local-projects/agentic-re-researcher && python -c "
from src.security.sanitization import SensitiveDataFilter, sanitize_text, install_log_sanitization
from src.security.validators import validate_run_id, validate_cache_path, validate_regions
print('Imports OK')

# Test sanitize_text
result = sanitize_text('key is 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')
assert '[REDACTED]' in result, f'Expected redaction, got: {result}'
assert 'pplx-' not in result, f'Key leaked: {result}'
print('Sanitization OK')

# Test run_id validation
try:
    validate_run_id('../etc/passwd')
    assert False, 'Should have rejected'
except ValueError:
    print('Run ID validation OK')

# Test region validation
try:
    validate_regions(['Fake Region XYZ'])
    assert False, 'Should have rejected'
except ValueError:
    print('Region validation OK')

validated = validate_regions(['queensland'])
assert validated == ['Queensland'], f'Expected normalization, got: {validated}'
print('Region normalization OK')

print('ALL CHECKS PASSED')
"
  </verify>
  <done>
    - SensitiveDataFilter redacts all .env values and common API key patterns from log records
    - sanitize_text function strips secrets from arbitrary strings
    - install_log_sanitization attaches filter to root logger and quiets third-party loggers
    - validate_run_id rejects path traversal and special chars
    - validate_cache_path prevents directory escape using pathlib resolve + is_relative_to
    - validate_regions rejects unknown regions with case-insensitive matching
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire sanitization into startup, models, and error handlers</name>
  <files>
    src/config/settings.py
    src/models/inputs.py
    src/app.py
    src/ui/web/server.py
  </files>
  <action>
**`src/config/settings.py`:**
- Add `validate_api_key_format(var_name: str, value: str) -> bool` function:
  - For `PERPLEXITY_API_KEY`: must start with `pplx-` and be 40+ chars
  - For `ANTHROPIC_API_KEY`: must start with `sk-ant-` and be 50+ chars
  - Unknown keys: return True (permissive fallback)
- Add `validate_environment()` function that runs BEFORE any other initialization:
  - Check required env vars exist (at least one of PERPLEXITY_API_KEY or ANTHROPIC_API_KEY)
  - Validate API key format for present keys
  - On failure: print clear error message with instructions (check .env file, verify at provider URL, see .env.example) and `sys.exit(1)`
  - IMPORTANT: Never print the actual key value in error messages
- Call `validate_environment()` at module level BEFORE setting PERPLEXITY_API_KEY etc.
- After validation, call `install_log_sanitization()` from `src.security.sanitization` to activate global log filtering
- Replace the existing bare `raise ValueError(...)` for missing keys with the new validation function

**`src/models/inputs.py`:**
- Update the existing `validate_regions` field_validator to call `validate_regions()` from `src.security.validators` (which does whitelist checking with case normalization)
- Add `@field_validator('run_id')` that calls `validate_run_id()` from `src.security.validators`
- Keep existing validators for num_suburbs and other fields

**`src/app.py`:**
- At the top of the file (after imports), no changes needed since settings.py now handles startup validation
- Verify that the existing error handling in `run_research_pipeline` doesn't leak secrets in error messages by wrapping any error messages through `sanitize_text()` before including in RunResult.error_message

**`src/ui/web/server.py`:**
- Add a global exception handler using `@app.exception_handler(Exception)` that:
  - Catches all unhandled exceptions
  - Sanitizes the error message using `sanitize_text()` before including in HTTP response
  - Returns JSON with `{"error": "Internal server error", "detail": sanitized_msg}`
  - Logs the full sanitized traceback at ERROR level
- Ensure the existing error handling in route handlers also sanitizes error messages before returning to client
  </action>
  <verify>
Run: `cd /Users/robertli/Desktop/local-projects/agentic-re-researcher && python -c "
import sys, os
sys.path.insert(0, 'src')

# Test that settings loads without error (requires valid .env)
from config import settings
print(f'Settings loaded, providers: {settings.AVAILABLE_PROVIDERS}')

# Test that logging filter is active
import logging
logger = logging.getLogger('test')
# The filter should be on root logger
root = logging.getLogger()
filter_names = [type(f).__name__ for f in root.filters]
assert 'SensitiveDataFilter' in filter_names, f'Filter not installed: {filter_names}'
print('Log sanitization active')

# Test UserInput validation
from models.inputs import UserInput
try:
    ui = UserInput(max_median_price=500000, dwelling_type='house', run_id='../../../etc/passwd')
    assert False, 'Should reject bad run_id'
except Exception as e:
    print(f'Bad run_id rejected: {type(e).__name__}')

try:
    ui = UserInput(max_median_price=500000, dwelling_type='house', regions=['Fake Region'])
    assert False, 'Should reject bad region'
except Exception as e:
    print(f'Bad region rejected: {type(e).__name__}')

# Valid input should work
ui = UserInput(max_median_price=500000, dwelling_type='house', regions=['Queensland'])
print(f'Valid input OK: {ui.regions}')

print('ALL CHECKS PASSED')
"
  </verify>
  <done>
    - settings.py validates API key format on startup and exits with clear instructions if invalid
    - Log sanitization is installed at module load time before any API calls
    - UserInput.run_id is validated against safe character pattern
    - UserInput.regions are validated against REGIONS whitelist with case normalization
    - FastAPI global exception handler sanitizes all error responses
    - No secret values can leak through log output, HTTP responses, or error messages
  </done>
</task>

</tasks>

<verification>
Phase success criteria addressed by this plan:
1. "API keys never appear in log output, error messages, or stack traces" -- SensitiveDataFilter on root logger + sanitize_text in HTTP handlers
2. "Submitting a region name not in the predefined whitelist is rejected" -- validate_regions in UserInput field_validator
3. "Run IDs and cache paths containing path traversal characters are rejected" -- validate_run_id and validate_cache_path
4. "A misconfigured or missing API key produces a clear startup error" -- validate_environment() in settings.py
</verification>

<success_criteria>
- `python -c "import logging; logging.getLogger('test').error('key=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')"` does NOT show the API key in output
- Creating UserInput with `run_id="../hack"` raises ValidationError
- Creating UserInput with `regions=["Nonexistent"]` raises ValidationError
- Creating UserInput with `regions=["queensland"]` succeeds with normalized `["Queensland"]`
- FastAPI error handler returns sanitized error messages
- Application starts with valid .env and fails with clear message when keys are malformed
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-error-foundations/01-01-SUMMARY.md`
</output>
